# ‚úÖ Correction Build Railway - Nixpacks

## üîç Probl√®me Identifi√©

Les builds Railway √©chouaient avec :
```
ERROR: "/yarn.lock": not found
ERROR: "/.yarnrc.yml": not found
```

## üéØ Cause du Probl√®me

**Le template Railway utilise Nixpacks (d√©tection automatique), pas Docker !**

Notre projet avait encore :
- ‚ùå `backend/Dockerfile` et `storefront/Dockerfile` (anciens)
- ‚ùå Dockerfiles cherchant `yarn.lock` et `.yarnrc.yml`
- ‚ùå Le template utilise `pnpm`, pas `yarn`

Railway essayait d'utiliser nos Dockerfiles obsol√®tes au lieu de d√©tecter automatiquement le projet Node.js/pnpm.

## ‚úÖ Corrections Appliqu√©es

### 1. Suppression des Dockerfiles

```bash
‚úÖ Supprim√© backend/Dockerfile
‚úÖ Supprim√© backend/.dockerignore
‚úÖ Supprim√© storefront/Dockerfile
‚úÖ Supprim√© storefront/.dockerignore
```

### 2. Nettoyage Yarn

```bash
‚úÖ Supprim√© backend/.yarn/
‚úÖ Supprim√© backend/.yarnrc.yml
‚úÖ Supprim√© storefront/.yarn/
‚úÖ Supprim√© storefront/.yarnrc.yml
```

### 3. Configuration pnpm Confirm√©e

```bash
‚úÖ backend/pnpm-lock.yaml pr√©sent
‚úÖ storefront/pnpm-lock.yaml pr√©sent
‚úÖ package.json configur√©s pour pnpm
```

## üöÄ Comment Railway Build Maintenant

### D√©tection Automatique Nixpacks

Railway va :

1. **D√©tecter** : Projet Node.js avec `pnpm-lock.yaml`
2. **Installer** : `pnpm install` automatiquement
3. **Builder Backend** :
   ```bash
   pnpm build
   # Ex√©cute: medusa build && node src/scripts/postBuild.js
   ```
4. **Builder Storefront** :
   ```bash
   pnpm build
   # Ex√©cute: next build
   ```
5. **D√©marrer** :
   - Backend: `pnpm start`
   - Storefront: `pnpm start`

### Avantages de Nixpacks

- ‚úÖ **Automatique** : Pas de Dockerfile √† maintenir
- ‚úÖ **Optimis√©** : Railway optimise le build
- ‚úÖ **Cache intelligent** : Layers automatiques
- ‚úÖ **D√©tection** : Reconna√Æt Medusa et Next.js

## üìä Structure Actuelle du Projet

```
b2b-starter-medusa/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ pnpm-lock.yaml ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scripts/postBuild.js ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ medusa-config.ts ‚úÖ
‚îú‚îÄ‚îÄ storefront/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ pnpm-lock.yaml ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ (PAS de Dockerfiles) ‚úÖ
```

## üîç V√©rification du Build Railway

### 1. Logs de Build

Dans Railway, vous devriez voir :

```
‚úì Detected Node.js application
‚úì Using pnpm
‚úì Installing dependencies...
‚úì Running build command...
‚úì Build successful
```

**PAS d'erreurs Docker !**

### 2. Backend Build

```bash
# Railway ex√©cute automatiquement
pnpm install
pnpm build
  ‚îî‚îÄ> medusa build
  ‚îî‚îÄ> node src/scripts/postBuild.js
```

### 3. Storefront Build

```bash
# Railway ex√©cute automatiquement
pnpm install
pnpm build
  ‚îî‚îÄ> next build
```

## ‚öôÔ∏è Configuration Railway

### Variables d'Environnement N√©cessaires

**Backend Service :**
```bash
DATABASE_URL=<auto-generated>
REDIS_URL=<auto-generated>
MINIO_ENDPOINT=<auto-generated>
MINIO_ACCESS_KEY=<auto-generated>
MINIO_SECRET_KEY=<auto-generated>

# √Ä configurer manuellement
JWT_SECRET=supersecret
COOKIE_SECRET=supersecret
STORE_CORS=https://<storefront-url>
ADMIN_CORS=https://<backend-url>
AUTH_CORS=https://<backend-url>
```

**Storefront Service :**
```bash
NEXT_PUBLIC_MEDUSA_BACKEND_URL=https://<backend-url>
NEXT_PUBLIC_BASE_URL=https://<storefront-url>
NEXT_PUBLIC_DEFAULT_REGION=us
REVALIDATE_SECRET=supersecret
```

## üéØ Timeline du Build

| √âtape | Dur√©e | Notes |
|-------|-------|-------|
| D√©tection | 5s | Nixpacks analyse le projet |
| Install deps | 1-2 min | `pnpm install` |
| Build Backend | 2-3 min | Inclut postBuild.js |
| Build Storefront | 1-2 min | Next.js build |
| D√©ploiement | 30s | Mise en ligne |
| **Total** | **~5-8 min** | Plus rapide que Docker |

## ‚úÖ Checklist Post-Fix

- [x] Dockerfiles supprim√©s
- [x] Art√©facts yarn supprim√©s
- [x] pnpm-lock.yaml pr√©sents
- [x] Code pouss√© vers GitHub
- [ ] Build Railway r√©ussi (v√©rifier logs)
- [ ] Backend accessible
- [ ] Admin fonctionne √† `/app`
- [ ] Storefront charge

## üÜò Si √áa √âchoue Encore

### 1. V√©rifier les Logs Railway

```bash
railway logs -f
```

Cherchez :
- ‚úÖ "Detected Node.js"
- ‚úÖ "Using pnpm"
- ‚ùå Pas de mentions de Docker
- ‚ùå Pas d'erreurs "yarn.lock not found"

### 2. Forcer un Rebuild

Dans Railway Dashboard :
1. Service ‚Üí Settings
2. "Redeploy" ou "Trigger Deploy"

### 3. V√©rifier les Variables

Assurez-vous que toutes les variables d'environnement sont d√©finies.

## üìö R√©f√©rences

- **Template Railway** : https://github.com/rpuls/medusa-b2b-for-railway
- **Railway Nixpacks** : https://nixpacks.com/
- **Medusa Docs** : https://docs.medusajs.com/v2

---

**Date** : 24 Octobre 2025  
**Fix** : Suppression Dockerfiles pour utilisation Nixpacks  
**Status** : ‚úÖ Pr√™t pour red√©ploiement Railway
